<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<div class="page-header">
  <script>
    console.log("updating page");
  </script>
   <h1> <%= @review.title %>
    <br>
    <small>
      <%= @review.description %>
    </small>
   </h1>
   <p>
    Posted by: <%= User.find(@review.user_id).user_name %>
   </p>
</div>

<p>
  This user has some question for you. Can you reply?
</p>

<p>
  <strong>First Question:</strong>
  <%= @review.question1 %> | <%= star_rating(get_point_question1(@review)) %> over <%= get_total_count_for_question1(@review) %> ratings
</p>

<p>
  <strong>Second Question:</strong>
  <%= @review.question2 %> | <%= star_rating(get_point_question2(@review)) %> over <%= get_total_count_for_question2(@review) %> ratings
</p>

<p>
  <strong>Thirth Question:</strong>
  <%= @review.question3 %> | <%= star_rating(get_point_question3(@review)) %> over <%= get_total_count_for_question3(@review) %> ratings
</p>

<hr>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
      <div id="map"></div>
    </div>
    <% if @review.picture != nil %>
      <div class="col-md-4">
        <%= image_tag( @review.picture.url,:size => '300x200') %>
      </div>
    <% end %>
  </div>
</div>

<hr>

<% if @review.user_id == session[:current_user_id] %>
  <%= link_to 'Edit', edit_review_path(@review), class: "btn btn-default btn-sm" %> |
<% end %>
<%= link_to 'Back', reviews_path, class: "btn btn-default btn-sm" %>

<hr>

<% if @ratings.exists? %>
<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading"><strong>Ratings</strong></div>
  <div class="panel-body">
    <% if !isLoggedIn? %>
    Please <%= link_to 'Login', login_path %> to post a rate <br>
    <%end%>
  </div>

<table class="table">
  
  <thead>
    <tr>
      <th>Note</th>
      <th>Created</th>
      <th><%= @review.question1 %></th>
      <th><%= @review.question2 %></th>
      <th><%= @review.question3 %></th>
      <th colspan="2"></th>
    </tr>
  </thead>
  <tbody>
  <% @ratings.each do |rating| %>
    <tr>
      <td><%= rating.description %></td>
      <td><%= time_ago_in_words(rating.created_at) %> ago</td>
      <td><%=star_rating(rating.rate_question1)%> </td>
      <td><%=star_rating(rating.rate_question2)%></td>
      <td><%=star_rating(rating.rate_question3)%></td>
       <td><%= link_to 'Show', review_rating_path(@review,rating), class: "btn btn-default btn-sm" %></td>      
        <% if isLoggedIn? and rating.user_id == get_current_user_id %>
          <td> |  <%= link_to 'Edit', edit_review_rating_path(@review,rating), class: "btn btn-default btn-sm" %> </td>
        <% end %>
    </tr>
  <% end %>
  </tbody>
  
</table>
</div>
<% end %>

<% if isLoggedIn? %>

<hr>

<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading"><strong>Add a rate</strong></div>
  <table class="table">
      <thead>
    <tr>
      <th>Description</th>
      <th><%= @review.question1 %></th>
      <th><%= @review.question2 %></th>
      <th><%= @review.question3 %></th>
      <th colspan="1"></th>
    </tr>
  </thead>
  
  <tbody>
   <tr>
    <%= form_for([@review, @review.ratings.build]) do |f| %>
       <td>
            <%= f.text_area :description %>
       </td>
       <td>
        <div class="field">
          <%= f.number_field :rate_question1 %>
        </div>
      </td>
      <td>
        <div class="field">
            <%= f.number_field :rate_question2 %>
        </div>
      </td>
      <td>
        <div class="field">
          <%= f.number_field :rate_question3 %>
        </div>
      </td>
      <td>
          <%= f.submit %>
      </td>
  <% end %>
   </tr>
</tbody>
</table>
</div>

<% end %>


<script>
   // if(navigator.geolocation)
    //      navigator.geolocation.getCurrentPosition(displayOnMap);

  var handler = Gmaps.build('Google');

  handler.buildMap({ internal: {id: 'map'} }, function(){
    //  if(navigator.geolocation)
    //      navigator.geolocation.getCurrentPosition(displayOnMap);
    
    markers_json = <%=raw @hash.to_json %>;
    markers = _.map(markers_json, function(marker_json){
            marker = handler.addMarker(marker_json);
            _.extend(marker, marker_json);
            return marker;
      });
      
    displayPoint(<%= @review.latitude %>, <%= @review.longitude %>);

    handler.fitMapToBounds();  
    handler.getMap().setZoom(21);  
    });
  
  function displayPoint(_lat, _lon){
    try {
      var marker = handler.addMarker({
        lat: _lat,
        lng: _lon
      });
    handler.map.centerOn(marker);
    }
    catch(error){}
};

</script>