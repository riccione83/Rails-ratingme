<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<div class="page-header">
  <script>
    console.log("updating page");
  </script>
   <h1> <%= @review.title %>
    <br>
    <small>
      <%= @review.description %>
    </small>
   </h1>
</div>

<div id="map"> </div>

<p>
  Posted by: <%= User.find(@review.user_id).user_name %>
</p>
<p>
  This user has some question for you. Can you reply?
</p>
<p>
  <strong>First Question:</strong>
  <%= @review.question1 %> | Point: <%= get_point_question1(@review) %> over <%= get_total_count_for_question1(@review) %> ratings
</p>

<p>
  <strong>Second Question:</strong>
  <%= @review.question2 %> | Point: <%= get_point_question2(@review) %> over <%= get_total_count_for_question2(@review) %> ratings
</p>

<p>
  <strong>Thirth Question:</strong>
  <%= @review.question3 %> | Point: <%= get_point_question3(@review) %> over <%= get_total_count_for_question3(@review) %> ratings
</p>

<% if @review.user_id == session[:current_user_id] %>
  <%= link_to 'Edit', edit_review_path(@review) %> |
<% end %>
<%= link_to 'Back', reviews_path %>

<hr>

<h2>Ratings</h2>
<% if !isLoggedIn? %>
    Please <%= link_to 'Login', login_path %> to post a rate <br>
<%end%>
<table>
  <% @ratings.each do |rating| %>
    <tr>
      <td><%= rating.description %> &nbsp; &nbsp; </td>
       <td><%= link_to 'Show', review_rating_path(@review,rating) %></td>      
        <% if isLoggedIn? and rating.user_id == get_current_user_id %>
          <td> |  <%= link_to 'Edit', edit_review_rating_path(@review,rating) %> </td>
        <% end %>
    </tr>
  <% end %>
</table>


<% if isLoggedIn? %>

<hr>

<h2>Add a rate:</h2>
<%= form_for([@review, @review.ratings.build]) do |f| %>
  <div class="field">
    <%= f.label :description %><br>
    <%= f.text_area :description %>
  </div>
  <div class="field">
    <%= f.label :rate_question1 %><br>
    <%= f.number_field :rate_question1 %>
  </div>
  <div class="field">
    <%= f.label :rate_question2 %><br>
    <%= f.number_field :rate_question2 %>
  </div>
  <div class="field">
    <%= f.label :rate_question3 %><br>
    <%= f.number_field :rate_question3 %>
  </div>

  <p>
    <%= f.submit %>
  </p>
<% end %>

<% end %>

<script>
    if(navigator.geolocation)
          navigator.geolocation.getCurrentPosition(displayOnMap);

  var handler = Gmaps.build('Google');

  handler.buildMap({ internal: {id: 'map'} }, function(){
    //  if(navigator.geolocation)
    //      navigator.geolocation.getCurrentPosition(displayOnMap);
    
    markers_json = <%=raw @hash.to_json %>;
    markers = _.map(markers_json, function(marker_json){
            marker = handler.addMarker(marker_json);
            _.extend(marker, marker_json);
            return marker;
      });
      
    displayPoint(<%= @review.latitude %>, <%= @review.longitude %>);
   // handler.bounds.extendWith(markers);
    handler.fitMapToBounds();  
    handler.getMap().setZoom(21);  
    });
  
  function displayPoint(_lat, _lon){
    var marker = handler.addMarker({
      lat: _lat,
      lng: _lon
    });
  handler.map.centerOn(marker);
};

  function displayOnMap(position){
    var marker = handler.addMarker({
      lat: position.coords.latitude,
      lng: position.coords.longitude
    });
  //handler.map.centerOn(marker);
  };
</script>